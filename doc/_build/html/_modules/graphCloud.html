<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>graphCloud &mdash; CloudCamera 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="CloudCamera 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for graphCloud</h1><div class="highlight"><pre>
<span class="c1"># /usr/bin/python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Cloud_Graph.py</span>
<span class="sd">Analyze and process images from the CloudCam. Applies masks, calculates</span>
<span class="sd">statistics, and outputs a .png image to analyzed/</span>

<span class="sd">All statistical information is saved in the FITS header,</span>
<span class="sd">and the FITS image is compressed.</span>

<span class="sd">TODO:</span>
<span class="sd">	Fix png naming to use a timestamp, not a chopped name</span>

<span class="sd">Dependencies:</span>
<span class="sd">	Run ./make to install all dependencies</span>

<span class="sd">Usage:</span>
<span class="sd">	Analyze all .fits images in images/:</span>
<span class="sd">		python Cloud_Graph.py</span>
<span class="sd">	Typically called from CloudCam.py</span>

<span class="sd">Output:</span>
<span class="sd">	Analyzed image, with histogram plot and statistics is</span>
<span class="sd">	output to analyzed as (Input_Name)_analyzed.png</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;J. Matt Armstrong&quot;</span><span class="p">]</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Joseph Huehnerhoff&quot;</span><span class="p">]</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;GPL&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;J. Matt Armstrong&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;jmarmstr@uw.edu&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Developement&quot;</span>


<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">Fits</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">bytescale</span> <span class="k">as</span> <span class="n">Scale</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="kn">as</span> <span class="nn">mtick</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">Cloud_Mask</span> <span class="kn">import</span> <span class="n">CloudMask</span>
<span class="kn">from</span> <span class="nn">transfer</span> <span class="kn">import</span> <span class="n">transfer</span>
<span class="kn">from</span> <span class="nn">CloudParams</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">clouduino_interface</span> <span class="kn">import</span> <span class="n">ClouduinoInterface</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<div class="viewcode-block" id="CloudGraph"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph">[docs]</a><span class="k">class</span> <span class="nc">CloudGraph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cm</span> <span class="o">=</span> <span class="n">CloudMask</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ci</span> <span class="o">=</span> <span class="n">ClouduinoInterface</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">transfer</span><span class="p">()</span>
		
		<span class="c1">#==&gt;  I think this is the memory leak, needs to be a local variable</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hdudata</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">None</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">scaleimg</span> <span class="o">=</span> <span class="n">scale_img</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rotate</span> <span class="o">=</span> <span class="n">rotate</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;galileo.apo.nmsu.edu&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;jwhueh&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">serverDir</span> <span class="o">=</span> <span class="s1">&#39;public_html/CloudCamera/&#39;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">None</span>


<div class="viewcode-block" id="CloudGraph.start_up_checks"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.start_up_checks">[docs]</a>	<span class="k">def</span> <span class="nf">start_up_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Run once at start-up</span>
<span class="sd">		Checks for necessary folders and files</span>
<span class="sd">		Creates them if necessary</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># Load masks into memory</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;masks/aperture_mask_500.npy&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
			<span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Loading mask files into memory.&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">print</span> <span class="p">(</span><span class="s2">&quot;Large aperture mask file not found, making one now.&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">make_aperture_mask</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">make_aperture_mask</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
			<span class="c1">#self.cm.make_wedge_mask(300)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">large_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;masks/aperture_mask_500.npy&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">small_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;masks/aperture_mask_400.npy&quot;</span><span class="p">)</span>
		<span class="k">return</span></div>

<div class="viewcode-block" id="CloudGraph.run_analysis"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.run_analysis">[docs]</a>	<span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">expose</span><span class="p">,</span> <span class="n">gain</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		This is where the code is actually run, so the total analysis</span>
<span class="sd">		package can be called from outside this file.</span>

<span class="sd">		Input: name of image in, name of image out, and chopped file name</span>
<span class="sd">		input:</span>
<span class="sd">			img_in			(name of input .fits image)</span>
<span class="sd">			img_out			(name of output png image)</span>
<span class="sd">			name 			(name file for timestamp)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span>  <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
		<span class="n">img_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s1">&#39;analyzed&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_analyzed.png&#39;</span><span class="p">)</span>
	
		<span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fits_to_list</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
		<span class="k">print</span> <span class="p">(</span><span class="s2">&quot;Analyzing &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="n">name_arr</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

		<span class="c1"># Use small mask to calculate image statistics</span>
		<span class="n">masked</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_mask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_mask</span><span class="p">)</span>
		<span class="k">print</span> <span class="p">(</span><span class="s2">&quot;Median = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">median</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, Mean = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, Standard Dev = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">std</span><span class="p">))</span>

		<span class="c1"># Calculate histogram for small maksed image</span>
		<span class="n">values</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_value_list</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span>
		<span class="n">fixed_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

		<span class="c1"># Use large mask to produce image</span>
		<span class="n">masked</span><span class="p">,</span> <span class="n">junk1</span><span class="p">,</span> <span class="n">junk2</span><span class="p">,</span> <span class="n">junk3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_mask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_mask</span><span class="p">)</span>
		<span class="c1">#print (&#39;end dynamic mask &#39;, (time.time() - self.start))</span>

		<span class="c1">#Fill in the masked image for processing</span>
                <span class="n">masked_img</span> <span class="o">=</span> <span class="n">masked</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaleimg</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">scaled_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_img</span><span class="p">(</span><span class="n">masked_img</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">scaled_img</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">masked_img</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotate</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">1280</span><span class="p">,</span><span class="mi">1024</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
		<span class="c1">#print (&#39;end rot and filter &#39;, (time.time() - self.start))</span>
		
                <span class="bp">self</span><span class="o">.</span><span class="n">mapImg</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;latest_map.png&#39;</span><span class="p">,</span> <span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
                <span class="c1">#self.mapImg(img, &#39;latestimg.png&#39;, &#39;gray&#39;)</span>
                
		<span class="c1"># Produce output png with histogram info</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">stat_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">median</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">name_arr</span><span class="p">,</span> <span class="n">gain</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fixed_vals</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">img_out</span><span class="p">,</span> <span class="n">stat_arr</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="c1"># Add image data to the FITS header, compress the image</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">add_headers</span><span class="p">(</span><span class="n">expose</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
		<span class="n">img</span> <span class="o">=</span> <span class="bp">None</span>
	
		<span class="k">print</span> <span class="p">(</span><span class="s1">&#39;end run_analysis &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">median</span></div>

<div class="viewcode-block" id="CloudGraph.fits_to_list"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.fits_to_list">[docs]</a>	<span class="k">def</span> <span class="nf">fits_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Try to open the fits file.</span>
<span class="sd">		If the file doesn&#39;t exist, say so and return.</span>
<span class="sd">		Otherwise, select just the image data as a numpy array</span>
<span class="sd">		and close the fits file.</span>

<span class="sd">		Input: File name</span>
<span class="sd">		Output: Numpy array of image data</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">hdudata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">Fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="c1">#print (&#39;end fits_to_list &#39;, (time.time() - self.start))</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdudata</span><span class="p">)</span></div>

<div class="viewcode-block" id="CloudGraph.dynamic_mask"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.dynamic_mask">[docs]</a>	<span class="k">def</span> <span class="nf">dynamic_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">maskname</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Creates a numpy mask on the image, filtering out any</span>
<span class="sd">		pixel values that are negative or saturated</span>

<span class="sd">		Input:</span>
<span class="sd">			image			(Aperture masked numpy image)</span>
<span class="sd">		Output: Masked numpy array covering any pixels above or below the standard dev range</span>
<span class="sd">			masked1			(masked numpy array)</span>
<span class="sd">			median	*Float*	(median value of masked array)</span>
<span class="sd">			mean	*Float*	(mean value of masked array)</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># Make a masked array using the static mask and imput image</span>
		<span class="n">pre_masked</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskname</span><span class="p">)</span>

		<span class="c1"># Mask saturated or empty</span>
		<span class="c1">#upper clipping</span>
		<span class="c1">#masked1 = ma.masked_greater(pre_masked, 254)</span>
		<span class="n">masked1</span> <span class="o">=</span> <span class="n">pre_masked</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">median</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">masked1</span><span class="p">))</span>
			<span class="n">mean</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">masked1</span><span class="p">)</span>
			<span class="n">std</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">masked1</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
			<span class="k">return</span>

		<span class="n">mean</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mean</span><span class="p">))</span>
		<span class="n">std</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">std</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">masked1</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span></div>

<div class="viewcode-block" id="CloudGraph.pixel_value_list"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.pixel_value_list">[docs]</a>	<span class="k">def</span> <span class="nf">pixel_value_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Produce two arrays, the first is a list of the binned pixel values</span>
<span class="sd">		and the second is the number of pixels at that value</span>

<span class="sd">		Input: masked numpy array of the image</span>
<span class="sd">		Output: Two lists of histogram data on the image. ([bins],[values])</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1"># Compress the array into a list of pixel values</span>
		<span class="n">compressed</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">compressed</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

		<span class="c1"># Find highest pixel value</span>
		<span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>

		<span class="c1"># Make a histogram of the compressed list</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">compressed</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CloudGraph.scale_img"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.scale_img">[docs]</a>	<span class="k">def</span> <span class="nf">scale_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Scale the image based on the median and std</span>
<span class="sd">		Brings out cloud detail</span>

<span class="sd">		input:</span>
<span class="sd">			img			(masked numpy image to scale)\</span>
<span class="sd">			median		(median value of image)</span>
<span class="sd">			std			(std value of image)</span>

<span class="sd">		output:</span>
<span class="sd">			result		(scaled image)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">median</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">std</span>
		<span class="k">elif</span> <span class="n">median</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">median</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
			<span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">std</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">scale</span><span class="o">=</span><span class="mi">20</span>
		
		<span class="n">bytehigh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">median</span> <span class="o">+</span> <span class="n">scale</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">median</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
			<span class="n">bytelow</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">bytelow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">median</span> <span class="o">-</span> <span class="n">scale</span><span class="p">)</span>
		
		<span class="n">result</span> <span class="o">=</span> <span class="n">Scale</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">cmax</span> <span class="o">=</span> <span class="n">bytehigh</span><span class="p">,</span> <span class="n">cmin</span> <span class="o">=</span> <span class="n">bytelow</span><span class="p">)</span> <span class="c1">#, high = bytehigh, low = bytelow)</span>
		<span class="n">result</span><span class="p">,</span> <span class="n">junk1</span><span class="p">,</span> <span class="n">junk2</span><span class="p">,</span> <span class="n">junk3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_mask</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">large_mask</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CloudGraph.plot_histogram"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.plot_histogram">[docs]</a>	<span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">img_out</span><span class="p">,</span> <span class="n">stat_arr</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Statistical plotting and output function.</span>

<span class="sd">		Input: Value list, Bin list, Name of output, Masked image, median value, mean value, standard dev, image name</span>
<span class="sd">			img		(image array)</span>
<span class="sd">			values 		(List of histogram counts)</span>
<span class="sd">			bins		(List of histogram bins)</span>
<span class="sd">			img_out		(Name of output image)</span>
<span class="sd">			stat_arr = [median, mean, std, name, gain]</span>

<span class="sd">		Output: png image file with the masked image, statistical and image information, and histogram plot</span>
<span class="sd">			Saves three copies of the image</span>
<span class="sd">				analyzed/img_out.png			(Archive storage location)</span>
<span class="sd">				gif/img_out.png					(Temp directory used to produce a gif)</span>
<span class="sd">				/var/www/html/latest.png		(Live view webpage displays this image)</span>
<span class="sd">			Every 10 images, produces a gif of the images in gif/</span>
<span class="sd">				/var/www/html/latest.png		(Live view webpage displays this gif)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

		<span class="c1">#Set up plotting environment</span>
		<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>       <span class="c1"># width, height</span>
		<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
		<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># height, width</span>

		<span class="c1">#Find timestamp, change this to use header info instead</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">timestamp</span> <span class="o">=</span> <span class="n">stat_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">)</span>
			<span class="n">text_name</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">  %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
			<span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

		<span class="c1">#Plot the masked image, allow for arbitrary rotation</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:</span><span class="mi">10</span><span class="p">,:</span><span class="mi">10</span><span class="p">])</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

		<span class="c1"># Insert statistical information into the image</span>

		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">1075</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1180</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">980</span><span class="p">,</span> <span class="n">text_name</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1020</span><span class="p">,</span> <span class="s1">&#39;Exposure = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; [s]&#39;</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1060</span><span class="p">,</span> <span class="s1">&#39;Gain = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">stat_arr</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1240</span><span class="p">,</span> <span class="mi">980</span> <span class="p">,</span> <span class="s1">&#39;Median = </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stat_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1240</span><span class="p">,</span> <span class="mi">1020</span><span class="p">,</span> <span class="s2">&quot;Mean = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stat_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1240</span><span class="p">,</span> <span class="mi">1060</span><span class="p">,</span> <span class="s1">&#39;Standard Dev = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stat_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>


		<span class="n">rainStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rainSensors</span><span class="p">()</span>
		<span class="k">print</span> <span class="s1">&#39;rainStatus: &#39;</span><span class="p">,</span> <span class="n">rainStatus</span>
		<span class="k">if</span> <span class="n">rainStatus</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Rain = Yes&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rainStatus</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Rain = No&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;Rain = Unknown&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
 

		<span class="c1">#Plot the histogram</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">,:</span><span class="mi">10</span><span class="p">])</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="p">(</span><span class="n">values</span><span class="o">*</span><span class="mf">100.0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel Value&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
		<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

		<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">stat_arr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
		<span class="n">dayDir</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
		<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;latest.png&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;latest.png&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/html/latest.png&quot;</span><span class="p">)</span>
		<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;latest.png&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s2">&quot;analyzed&quot;</span><span class="p">,</span> <span class="n">dayDir</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s2">&quot;_analyzed.png&quot;</span><span class="p">))</span>
		<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;latest.png&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s2">&quot;gif&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">))</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">uploadFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;latest.png&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverDir</span><span class="p">)</span>

		<span class="c1">#change memory pointer to allow for garbage collection</span>
		<span class="n">img</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">fig</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">gs</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">masked_img</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="c1">#print (&#39;end plot_hist &#39;, (time.time() - self.start))</span>
		<span class="k">return</span></div>


<div class="viewcode-block" id="CloudGraph.rainSensors"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.rainSensors">[docs]</a>	<span class="k">def</span> <span class="nf">rainSensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">rain</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s1">&#39;rain.dat&#39;</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
				<span class="n">rain</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
			<span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span>
		<span class="k">print</span> <span class="n">rain</span>
		<span class="k">return</span> <span class="n">rain</span></div>
		

<div class="viewcode-block" id="CloudGraph.rainSensorsOld"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.rainSensorsOld">[docs]</a>	<span class="k">def</span> <span class="nf">rainSensorsOld</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="o">.</span><span class="n">openPort</span><span class="p">()</span>
                <span class="n">rain</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="o">.</span><span class="n">checkRain1</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="o">.</span><span class="n">checkRain2</span><span class="p">()]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ci</span><span class="o">.</span><span class="n">closePort</span><span class="p">()</span>
		<span class="k">print</span> <span class="p">(</span><span class="s1">&#39;rain sensors (1|2): &#39;</span><span class="p">,</span><span class="n">rain</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>		
		<span class="k">return</span> <span class="n">rain</span></div>

<div class="viewcode-block" id="CloudGraph.mapImg"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.mapImg">[docs]</a>	<span class="k">def</span> <span class="nf">mapImg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imArr</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
		<span class="n">fig1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">9.5</span><span class="p">))</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imArr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="nb">map</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
		<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/var/www/html/&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>
		<span class="c1">#if map == &#39;inferno&#39;:</span>
		<span class="c1">#	shutil.copyfile(name, os.path.join(os.getcwd(),&quot;gif_map&quot;,time.strftime(&quot;%Y%m%dT%H%M%S_map.png&quot;)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">uploadFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serverDir</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="n">fig1</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
		<span class="n">fig1</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="c1">#print (&#39;end mapImg &#39;, (time.time() - self.start))</span>
		<span class="k">return</span></div>

<div class="viewcode-block" id="CloudGraph.add_headers"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.add_headers">[docs]</a>	<span class="k">def</span> <span class="nf">add_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expose</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add statistical and image information</span>
<span class="sd">		to the FITS header, close the FITS file,</span>
<span class="sd">		and zip the image to save space.</span>

<span class="sd">		Input:</span>
<span class="sd">			expose 		The length of the image exposure in seconds</span>
<span class="sd">			median		The statistical median of the image</span>
<span class="sd">			std			The statistical standard dev. of the image</span>
<span class="sd">			img_in		The name of the image</span>

<span class="sd">		Output:</span>
<span class="sd">			Saved and compressed FITS image</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># Add info to the FITS header</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;IMG_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;IMAGTYP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CloudCam&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">expose</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MEDIAN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">median</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;STD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span>
		<span class="n">img_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
		<span class="c1"># Close and compress the FITS file, saving the header</span>
		<span class="n">compressed</span> <span class="o">=</span> <span class="n">Fits</span><span class="o">.</span><span class="n">CompImageHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdudata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">])</span>
		<span class="n">compressed</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">img_out</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="n">compressed</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="c1">#zip output</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">zipFile</span><span class="p">(</span><span class="n">img_out</span><span class="p">)</span>
		<span class="k">print</span> <span class="p">(</span><span class="s1">&#39;end add_headers &#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span></div>

<div class="viewcode-block" id="CloudGraph.zipFile"><a class="viewcode-back" href="../source/graphCloud.html#graphCloud.CloudGraph.zipFile">[docs]</a>	<span class="k">def</span> <span class="nf">zipFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
		 <span class="c1">#zip output</span>
                <span class="n">f_in</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">f_out</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="s1">&#39;.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
		<span class="k">return</span></div></div>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">cg</span> <span class="o">=</span> <span class="n">CloudGraph</span><span class="p">()</span>
	<span class="n">cg</span><span class="o">.</span><span class="n">start_up_checks</span><span class="p">()</span>

	<span class="n">cg</span><span class="o">.</span><span class="n">run_analysis</span><span class="p">(</span><span class="s1">&#39;images/20160726/20160726T095434_0.020&#39;</span><span class="p">,</span> <span class="s1">&#39;0.2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span> <span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Matt Armstrong, Joseph Huehnerhoff.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>